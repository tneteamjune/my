{% extends 'layouts/default.html' %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <style>
            .wrap {position: absolute;left: 0;bottom: 30px;width: 288px;height: 132px;margin-left: -144px;text-align: left;overflow: hidden;font-size: 12px;font-family: 'Malgun Gothic', dotum, '돋움', sans-serif;line-height: 1.5;}
            .wrap * {padding: 0;margin: 0;}
            .wrap .info {width: 286px;height: 120px;border-radius: 5px;border-bottom: 2px solid #ccc;border-right: 1px solid #ccc;overflow: hidden;background: #fff;}
            .wrap .info:nth-child(1) {border: 0;box-shadow: 0px 2px 3px #888;}
            .info .title {padding: 5px 0 0 10px;height: 30px;background: #eee;border-bottom: 1px solid #ddd;font-size: 12px;font-weight: bold;}
            .info .close {position: absolute;top: 10px;right: 10px;color: #888;width: 17px;height: 17px;background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/overlay_close.png');}
            .info .close:hover {cursor: pointer;}
            .info .body {position: relative;overflow: hidden;}
            .info .desc {position: relative;margin: 6px 0 0 80px;height: 75px;}
            .desc .ellipsis {overflow: hidden;text-overflow: ellipsis;white-space: normal; text-align: left;}
            .desc .jibun {font-size: 11px;color: #888;margin-top: -2px;}
            .info .img {position: absolute;top: 6px;left: 5px;width: 73px;height: 71px;border: 1px solid #ddd;color: #888;overflow: hidden;}
            .info:after {content: '';position: absolute;margin-left: -12px;left: 50%;bottom: 0;width: 22px;height: 12px;background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/vertex_white.png')}
            .info .link {color: #5085BB;}
        </style>

    <!-- Page content-->
            
    <div id="map" style="width:100%%;height:100vh;"></div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=231a33db8742d9b1092898af03f0d832"></script>
    <script>
        var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
            mapOption = {
                center: new kakao.maps.LatLng(36.332208, 127.434075), // 지도의 중심좌표 
                //대전역(36.332208, 127.434075) 노들섬(37.517473, 126.959394)
                level: 7, // 지도의 확대 레벨
            }; 

        // 지도를 생성한다 
        var map = new kakao.maps.Map(mapContainer, mapOption);
        
        // 지도 확대 축소를 제어할 수 있는 줌 컨트롤을 생성합니다 
        var zoomControl = new kakao.maps.ZoomControl(); map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

        // 일반 지도와 스카이뷰로 지도 타입을 전환할 수 있는 지도타입 컨트롤을 생성합니다
        var mapTypeControl = new kakao.maps.MapTypeControl();

        // 지도에 컨트롤을 추가해야 지도위에 표시됩니다
        // kakao.maps.ControlPosition은 컨트롤이 표시될 위치를 정의하는데 TOPRIGHT는 오른쪽 위를 의미합니다
        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);
        
        // HTML5의 geolocation으로 사용할 수 있는지 확인합니다 
if (navigator.geolocation) {
    
    // GeoLocation을 이용해서 접속 위치를 얻어옵니다
    navigator.geolocation.getCurrentPosition(function(position) {
        
        var lat = position.coords.latitude, // 위도
            lon = position.coords.longitude; // 경도
        
        var locPosition = new kakao.maps.LatLng(lat, lon), // 마커가 표시될 위치를 geolocation으로 얻어온 좌표로 생성합니다
            message = '<div style="padding:5px;">여기에 계신가요?!</div>'; // 인포윈도우에 표시될 내용입니다
        
        // 마커와 인포윈도우를 표시합니다
        displayMarker(locPosition, message);
            
      });
    
} else { // HTML5의 GeoLocation을 사용할 수 없을때 마커 표시 위치와 인포윈도우 내용을 설정합니다
    
    var locPosition = new kakao.maps.LatLng(33.450701, 126.570667),    
        message = 'geolocation을 사용할수 없어요..'
        
    displayMarker(locPosition, message);
}

        var positions = []
        // 마커를 표시할 위치와 title 객체 배열입니다
        {% for MapInfo in MapInfos %}
        {% load tag_library %}
        var lat = {{MapInfo.lat|to_float}};
        var lng = {{MapInfo.lng|to_float}};
        positions.push({
                number:`${{MapInfo.id}}`,
                title:`{{MapInfo.title}}`,
                latlng: new kakao.maps.LatLng(lat,lng),
                content:`{{MapInfo.content}}`,
            }) 
        {%endfor%}

 
        // (test)커스텀 오버레이로 마커 생성
        for(let i=0; i < positions.length; i++){
        var data = positions[i];
        displayMarker(data);
        }
    
        // 지도에 마커를 표시하는 함수입니다    
        function displayMarker(data) { 

        if (data.title.includes("재활용")) {
        var imageSrc = '/static/image/recycle_icon.png'
        } else { var imageSrc = '/static/image/icon.png' }

        imageSize = new kakao.maps.Size(40, 60), 
        imageOption = {offset: new kakao.maps.Point(27, 69)}; 

        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption),
        markerPosition = new kakao.maps.LatLng(37.54699, 127.09598); // 마커가 표시될 위치입니다

        var marker = new kakao.maps.Marker({
            map: map,
            position: data.latlng,
            image: markerImage
        });
        var overlay = new kakao.maps.CustomOverlay({
            yAnchor: 3,
            position: marker.getPosition()
        });
        
        var content = document.createElement('div');
        content.innerHTML = '<div class="wrap">' + 
            '    <div class="info">' + 
                '        <div class="title">' + 
                    '            <div>' 
                        + data.title + '</div>' +
                '        </div>' + 
                '        <div class="body">' + 
                '            <div class="img">' +
                '                <img src="/static/image/trash_logo.jpg" width="73" height="70">' +
                '           </div>' + 
                '            <div class="desc">' + 
                '                <div class="ellipsis">'+ data.content + '</div>' + 
                '                <div class="jibun ellipsis">'+ data.latlng + '</div>' + 
                '                <div><a href="{% url 'common:report' %}" target="_blank" class="link">오류신고 페이지</a></div>' + 
                '            </div>' + 
                '        </div>' + 
                '    </div>' +    
                '</div>';
        content.style.cssText = '';
            

        var closeBtn = document.createElement('button');
        closeBtn.innerHTML = '<a class="text-secondary";><h7>close</h7></a>';
        closeBtn.style.cssText = '<a class="text-info"';
        closeBtn.onclick = function () {
            overlay.setMap(null);
        };
        content.appendChild(closeBtn);
        overlay.setContent(content);
    
        kakao.maps.event.addListener(marker, 'click', function() {
            overlay.setMap(map);
        });
    } 


     </script>                

            </div>
        </div>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="{% static 'js/scripts.js'%}"></script>

    </body>
</html>
{% endblock %}